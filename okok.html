<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Fleet Brain</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: url('indian-mechanic-roadside-authentic.jpg') center/cover fixed; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        canvas { position: absolute; top: 60px; left: 0; width: 100%; }
        
        /* HEADER - TOP FIXED */
        .header { width: 100%; height: 60px; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 20; border-bottom: 1px solid #00d2d3; }
        h1 { color: #00d2d3; font-size: 1.8em; text-shadow: 0 0 20px #00d2d3; letter-spacing: 3px; }
        
        /* MAIN CONTAINER - Flex layout */
        #container { display: flex; flex: 1; margin-top: 0; }
        
        /* LEFT SIDEBAR */
        .left { width: 240px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        .card { background: rgba(10,30,50,0.85); border: 1px solid rgba(0,210,211,0.3); border-left: 4px solid #00d2d3; border-radius: 8px; padding: 12px; color: white; transition: all 0.3s; }
        .card h3 { font-size: 1.1em; margin-bottom: 4px; }
        .card p { font-size: 0.75em; color: #888; margin: 3px 0; }
        .card span { color: #1dd1a1; font-weight: bold; font-size: 0.85em; }
        .card.alert { border-left-color: #ff4757; background: rgba(80,20,20,0.9); }
        .card.alert span { color: #ff6b81; animation: blink 0.8s infinite; }
        
        /* CENTER - 3D Model space */
        .center { flex: 1; position: relative; }
        
        /* RIGHT SIDEBAR */
        .right { width: 250px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 15px; z-index: 10; }
        .log { background: rgba(0,0,0,0.85); border: 1px solid #00d2d3; color: #00d2d3; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 0.9em; max-width: 220px; max-height: 100px; overflow-y: auto; }
        button { background: rgba(0,210,211,0.2); color: #00d2d3; border: 2px solid #00d2d3; padding: 12px 24px; font-weight: bold; cursor: pointer; border-radius: 6px; transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px; }
        button:hover { background: #00d2d3; color: #000; transform: scale(1.05); }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* Scrollbar styling */
        .left::-webkit-scrollbar { width: 6px; }
        .left::-webkit-scrollbar-track { background: rgba(0,210,211,0.1); border-radius: 3px; }
        .left::-webkit-scrollbar-thumb { background: #00d2d3; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- HEADER AT TOP -->
    <div class="header">
        <h1>‚ö° Autonomous Fleet Brain</h1>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="container">
        <!-- LEFT SIDEBAR -->
        <div class="left">
            <div class="card" id="card-Kritagya"><h3>Kritagya</h3><p>DL-10-KR-001</p><span id="status-Kritagya">Active</span></div>
            <div class="card" id="card-Atul"><h3>Atul</h3><p>UP-16-AT-002</p><span id="status-Atul">Active</span></div>
            <div class="card" id="card-Piyush"><h3>Piyush</h3><p>HR-26-PI-003</p><span id="status-Piyush">Active</span></div>
            <div class="card" id="card-Shivam"><h3>Shivam</h3><p>MH-04-SH-004</p><span id="status-Shivam">Active</span></div>
        </div>

        <!-- CENTER - 3D MODEL -->
        <div class="center"></div>

        <!-- RIGHT SIDEBAR -->
        <div class="right">
            <div class="log" id="log">System Ready...</div>
            <button onclick="scan()">SCAN FLEET</button>
        </div>
    </div>

    <audio id="audio" style="display:none;"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 3D Setup
        const scene = new THREE.Scene();
        const container = document.querySelector('.center');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        camera.position.set(0, 0, 15);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        renderer.setClearColor(0x000000, 0);
        container.appendChild(renderer.domElement);

        // Core at center
        const core = new THREE.Mesh(
            new THREE.IcosahedronGeometry(3, 2), 
            new THREE.MeshBasicMaterial({ color: 0x00d2d3, wireframe: true, wireframeLinewidth: 2 })
        );
        scene.add(core);

        // Inner solid core
        const innerCore = new THREE.Mesh(
            new THREE.IcosahedronGeometry(1.5, 2),
            new THREE.MeshBasicMaterial({ color: 0x00d2d3 })
        );
        scene.add(innerCore);

        // Fleet vehicles orbiting
        const bikes = {}, users = ['Kritagya', 'Atul', 'Piyush', 'Shivam'], radius = 10;
        users.forEach((name, i) => {
            const angle = (i / 4) * Math.PI * 2;
            const mesh = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 0.6, 2.5), 
                new THREE.MeshBasicMaterial({ color: 0x00d2d3 })
            );
            mesh.userData = { angle, name };
            scene.add(mesh);
            bikes[name] = mesh;
        });

        // Connecting lines
        const linesMat = new THREE.LineBasicMaterial({ color: 0x00d2d3, transparent: true, opacity: 0.3 });
        users.forEach((name, i) => {
            const angle = (i / 4) * Math.PI * 2;
            const points = [
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(Math.cos(angle) * radius, 0, Math.sin(angle) * radius)
            ];
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, linesMat);
            scene.add(line);
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            core.rotation.x += 0.003;
            core.rotation.y += 0.008;
            innerCore.rotation.y -= 0.012;

            Object.values(bikes).forEach(bike => {
                bike.userData.angle += 0.004;
                bike.position.x = Math.cos(bike.userData.angle) * radius;
                bike.position.z = Math.sin(bike.userData.angle) * radius;
                bike.rotation.y = -bike.userData.angle;
            });
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        });

        // API Integration
        const log = document.getElementById('log');
        
        async function scan() {
            log.innerText = 'üîç Scanning...';
            Object.entries(bikes).forEach(([name, mesh]) => {
                mesh.material.color.setHex(0x00d2d3);
                document.getElementById(`card-${name}`).classList.remove('alert');
                document.getElementById(`status-${name}`).innerText = 'Active';
            });

            try {
                const res = await fetch('http://localhost:5000/api/start-journey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autonomous: true })
                });
                const data = await res.json();

                if (data.success) {
                    const { owner, issue, risk, audio_url } = data.data;
                    const color = risk === 'critical' ? 0xff4757 : 0xffa502;
                    bikes[owner].material.color.setHex(color);
                    document.getElementById(`card-${owner}`).classList.add('alert');
                    document.getElementById(`status-${owner}`).innerText = `‚ö†Ô∏è ${issue}`;
                    log.innerText = `üö® ${owner}:\n${issue}\n[${risk.toUpperCase()}]`;
                    if (audio_url) document.getElementById('audio').src = audio_url, document.getElementById('audio').play().catch(() => {});
                }
            } catch (e) {
                log.innerText = '‚ùå Connection Failed';
            }
        }
    </script>
</body>
</html>
